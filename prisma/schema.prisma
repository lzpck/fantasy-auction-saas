generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum RoomStatus {
  DRAFT
  OPEN
  PAUSED
  COMPLETED
}

enum PlayerStatus {
  PENDING
  NOMINATED
  SOLD
  UNSOLD
}

enum BidStatus {
  VALID
  RETRACTED // status util para a regra de "retirar lance" sem multa
  VOID      // lances invalidados tecnicamente
}



// --- MODELS ---

model User {
  id           String        @id @default(cuid())
  name         String
  email        String        @unique
  passwordHash String
  createdAt    DateTime      @default(now())
  rooms        AuctionRoom[]
}

model AuctionRoom {
  id        String     @id @default(cuid())
  name      String

  sleeperId String?    // ID da liga no Sleeper (opcional)
  status    RoomStatus @default(DRAFT)
  
  ownerId   String
  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Configuracoes tipadas em src/types/auction-settings.ts
  settings  String     // persistido como JSON stringificado para compatibilidade SQLite
  
  teams     AuctionTeam[]
  items     AuctionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuctionTeam {
  id             String   @id @default(cuid())
  auctionRoomId  String
  
  name           String
  ownerName      String?  // nome do dono no Sleeper ou manual
  sleeperOwnerId String?  // ID do usuario no Sleeper (para avatar/sync)
  
  // Economia
  budget       Float    // Salary Cap ou FAAB disponivel inicial
  rosterSpots  Int      // vagas totais disponiveis

  // Seguranca (PIN de acesso)
  pinHash      String?  // se null, time ainda nao foi reivindicado
  
  auctionRoom   AuctionRoom @relation(fields: [auctionRoomId], references: [id], onDelete: Cascade)
  bids          Bid[]


  @@index([auctionRoomId])
}

model AuctionItem {
  id            String       @id @default(cuid())
  auctionRoomId String
  
  name          String
  position      String
  nflTeam       String?      // ex: "KC", "BUF"
  
  status        PlayerStatus @default(PENDING)
  
  // Resultado do leilao
  winningBidId  String?      @unique
  winningTeamId String?
  contractYears Int?         // calculado ao fechar o leilao
  expiresAt     DateTime?    // Data/hora de expiracao do lance atual
  
  auctionRoom   AuctionRoom  @relation(fields: [auctionRoomId], references: [id], onDelete: Cascade)
  bids          Bid[]
  winningBid    Bid?         @relation("BidWonItem", fields: [winningBidId], references: [id])

  @@index([auctionRoomId])
}

model Bid {
  id            String    @id @default(cuid())
  auctionItemId String
  teamId        String
  
  amount        Float
  contractYears Int?      // Anos de contrato propostos neste lance
  timestamp     DateTime  @default(now())
  status        BidStatus @default(VALID)

  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id], onDelete: Cascade)
  team          AuctionTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  // Relacao inversa para saber se este bid foi o vencedor
  wonItem       AuctionItem? @relation("BidWonItem")

  @@index([auctionItemId])
  @@index([teamId])
}


